<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Assistant IA — Travely</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --tv-blue:#02174C; --tv-green:#12E882;
      --dock-gap:10px; --dock-pad:10px;
      --dock-input-h:56px;
    }
    /* Starry everywhere + no bottom gap */
    html, body { height: 100%;
    margin: 0;
    overflow: hidden; /* empêche le scroll vertical */
}

.bg-starry {
    height: 100vh; /* prend toute la hauteur visible */
    display: flex;
    flex-direction: column;
    justify-content: center; /* centre verticalement le contenu */
 }
    body{
      margin:0;
      background: url('/static/images/starry-background.jpg') center/cover fixed no-repeat;
      color:#fff;
    }

    /* Hide the below shell until chat appears (prevents empty area below hero) */
    .shell { display:none; max-width: 1120px; margin: 0 auto; padding: 0 12px 40px; }
    .show-hero-chat .shell{ display:block; }
    .panel { background:#fff; border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,.1); }
    .grid { display:grid; grid-template-columns: 1fr; gap:18px; align-items:start; }
    .show-map .grid { grid-template-columns: 1fr 520px; }
    #mapPanel{ display:none; }
    .show-map #mapPanel{ display:block; }

    /* Chat log styles */
    .chat-panel{ padding:8px; position:relative; width:100%; max-width:1120px; margin:0 auto; }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
    .bar h2{ color:var(--tv-blue); margin:0; font-size:1.1rem; }
    .chat-log { display:flex; flex-direction:column; gap:10px; max-height: 58vh; overflow-y:auto; padding:12px; border:1px solid #eee; border-radius:12px; background:#fff; color:#222; }
    .line{ display:flex; }
    .line.ai{ justify-content:flex-start; }
    .line.me{ justify-content:flex-end; }
    .bubble { margin: 0; padding:12px 14px; border-radius:14px; display:inline-block; max-width:80%; line-height:1.5; }
    .bubble.me { background:var(--tv-green); color:var(--tv-blue); border-top-right-radius:6px; }
    .bubble.ai { background:var(--tv-blue); color:#fff; border-top-left-radius:6px; }

    /* HERO starry — perfectly centered vertically */
    .hero.bg-starry{
      position:relative; display:flex; align-items:center; justify-content:center;
      min-height:100vh; text-align:center; padding: 72px 0 32px;
    }
    .hero-stack{ width:100%; max-width: 1280px; margin: 0 auto; }
    .hero-stack h1{ margin-bottom:8px; color:var(--tv-green); }
    .hero-stack p{ opacity:.92; margin-bottom:16px; }

    /* Suggestions — made smaller, centered to input width */
    .sugg-wrap{ width:100%; display:flex; justify-content:center; }
    .sugg-list{
      width:66vw; max-width:1120px; position:relative; overflow:hidden;
      padding:10px 12px; border-radius:999px;
      /* CHANGE: retirer le “carré blanc” de fond */
      background:transparent !important; border:none !important; box-shadow:none !important;
    }
    .sugg-track{ display:flex; gap:10px; align-items:center; will-change: transform; animation: sugg-loop 28s linear infinite; }
    .sugg-wrap:hover .sugg-track{ animation-play-state: paused; }
    @keyframes sugg-loop{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .sugg-pill{
      flex:0 0 auto; padding:6px 12px; border-radius:999px;
      border:1px solid rgba(2,23,76,.18); background:#fff; cursor:pointer;
      color:var(--tv-blue); font-weight:500; font-size:.9rem; white-space:nowrap;
      box-shadow:0 2px 5px rgba(0,0,0,.06);
    }
    .sugg-pill:hover{ border-color: var(--tv-green); }

    /* Input bar: more prominent (bigger + bold) + plus menu + round send */
    .hero-form{ padding: 0 !important ; width:100%; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .hero-input{
      width:66vw; max-width:1120px; display:flex; gap:8px; align-items:center;
      background:rgba(255,255,255,.98); border:1px solid rgba(2,23,76,.18);
      border-radius:999px; padding:6px; box-shadow:0 10px 22px rgba(0,0,0,.18);
      position:relative;
    }
    .hero-input textarea{
      /* CHANGE: donner plus de place au texte dans la même barre */
      flex:1 1 auto; width:auto; margin:0; align-self:center;
      min-height:34px; max-height:120px; resize:none; overflow:hidden;
      padding:8px 12px; /* top/bottom 8px pour meilleur centrage */
      border:none; outline:none; background:transparent;
      color:var(--tv-blue); caret-color: var(--tv-blue);
      font-size:1.05rem; font-weight:700; line-height:1.4; /* légèrement plus haut */
    }
    .hero-input textarea::placeholder{ color:#6b7aa6; font-weight:600; }

    /* Iconic buttons */
    .icon-btn{ width:38px; height:38px; border-radius:999px; border:none; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; background:#eef3ff; color:var(--tv-blue); font-size:1.1rem; }
    .icon-btn:hover{ filter: brightness(0.96); }
    .send-btn{ background: var(--tv-green); color: var(--tv-blue); font-weight:800; }
    .send-btn:hover{ filter: brightness(0.95); }
    /* CHANGE: bouton Envoyer plus fin, forme ronde compacte */
    #sendBtn{ width:34px; height:34px; flex:0 0 34px; padding:0; }

    /* Floating options menu (opened by +) */
    .options-menu{
      position:absolute; transform: translateY(calc(100% + 8px)); left:0;
      background:#fff; color:#222; border-radius:12px; border:1px solid #e6e6e6;
      box-shadow:0 12px 24px rgba(0,0,0,.18); padding:6px; width:220px; display:none; z-index:60;
    }
    .options-menu.open{ display:block; }
    .options-menu button{
      width:100%; text-align:left; background:transparent; border:none; padding:10px 10px;
      border-radius:8px; cursor:pointer; color:#123; font-size:.95rem;
    }
    .options-menu button:hover{ background:#f2f6ff; }

    /* Hide legacy large control row */
    .hero-controls{ display:none; }

    .minibtn { background: transparent; border:1px solid var(--tv-green); color: var(--tv-green); border-radius:999px; padding:8px 12px; font-size:.9rem; }
    .minibtn:hover{ background: var(--tv-green); color: var(--tv-blue); }

    /* After first message: dock suggestions + input fixed bottom; only chat scrolls */
    .chat-live .sugg-wrap,
    .chat-live .hero-form{ position:fixed; left:0; right:0; display:flex; justify-content:center; z-index:50; }
    .chat-live .hero-form{ bottom:0; padding: var(--dock-pad); backdrop-filter: blur(10px); }
    .chat-live .sugg-wrap{ bottom: calc(var(--dock-input-h) + var(--dock-gap) + var(--dock-pad)); padding: 0 var(--dock-pad); }
    .chat-live .hero-input{ width:66vw; }
    .chat-live #heroChatMount .chat-log{ max-height: calc(100vh - 220px); }

    /* Mount area for chat after first message */
    #heroChatMount{ width:100%; display:none; margin-top:12px; }
    .show-hero-chat #heroChatMount{ display:block; }

    /* Drawer Filtres — fully hidden when closed + backdrop; no ghost in background */
    .drawer {
      position: fixed; top:0; right:0; width: 380px; max-width:calc(100% - 40px);
      height: 100vh; background:#fff; box-shadow: -10px 0 28px rgba(0,0,0,.2);
      transform: translateX(100%); opacity:0; pointer-events:none; visibility:hidden;
      transition: transform .35s ease, opacity .2s ease, visibility 0s linear .35s;
      z-index: 999; padding:18px; overflow:auto; display:block;
    }
    .drawer.open { transform: translateX(0); opacity:1; pointer-events:auto; visibility:visible; transition-delay: 0s; }
    .backdrop { position:fixed; inset:0; background: rgba(0,0,0,.34); opacity:0; pointer-events:none; transition: opacity .2s ease; z-index: 998; }
    .backdrop.show { opacity:1; pointer-events:auto; }

    .drawer h3{ color:var(--tv-blue); margin-bottom:10px; }
    label{ display:block; margin-top:10px; font-weight:600; color:#333; }
    input, select{ width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:6px; }
    .row{ display:flex; gap:8px; }
    .row > *{ flex:1; }

    /* Map */
    #map { height: 70vh; border-radius:12px; }
    @media (max-width: 1100px){ .show-map .grid{ grid-template-columns: 1fr 460px; } }
    @media (max-width: 980px){
      .show-map .grid{ grid-template-columns: 1fr; }
      #map{ height: 50vh; }
      .chat-live .hero-input{ width:90vw; }
      .sugg-list{ width:90vw; }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo"><a href="{{ url_for('home') }}">Travely</a></div>
    <nav>
      <ul>
        <li><a class="active" href="{{ url_for('assistant') }}">Assistant</a></li>
        <li><a href="{{ url_for('preferences') }}">Mes préférences</a></li>
        <li><a href="{{ url_for('mes_voyages') }}">Mes voyages</a></li>
        <li><a href="{{ url_for('carte') }}">Suivi sur carte</a></li>
      </ul>
    </nav>
    <div class="actions">
      <button id="btnFilters" class="minibtn" aria-haspopup="dialog" aria-controls="filtersDrawer">Filtres</button>
      <button id="btnToggleMap" class="minibtn">Afficher la carte</button>
    </div>
  </header>

  <!-- Backdrop for drawer -->
  <div id="backdrop" class="backdrop" hidden></div>

  <!-- HERO starry: suggestions au-dessus, barre au milieu, chat dessous (masqué au chargement) -->
  <section class="hero bg-starry">
    <div class="hero-stack">
      <h1>Assistant IA de voyage</h1>
      <p>Commence par décrire ton voyage.</p>

      <!-- Suggestions dynamiques liées aux réponses de l'IA -->
      <div class="sugg-wrap">
        <div class="sugg-list">
          <div id="suggTrack" class="sugg-track" aria-live="polite"></div>
        </div>
      </div>

      <form id="heroForm" class="hero-form" autocomplete="off">
        <div class="hero-input">
          <!-- PLUS button + floating menu -->
          <button type="button" id="plusBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="optionsMenu">＋</button>
          <textarea id="heroMsg" rows="1" placeholder="Parle-moi de ton voyage (ex : 7 jours à Tokyo en novembre, 1500€ tout compris)"></textarea>
          <!-- Small round arrow send -->
          <button type="submit" id="sendBtn" class="icon-btn send-btn" aria-label="Envoyer">➤</button>

          <div id="optionsMenu" class="options-menu" role="menu" aria-hidden="true">
            <button type="button" id="optSave" role="menuitem">💾 Enregistrer</button>
            <button type="button" id="optClear" role="menuitem">🧹 Effacer</button>
            <button type="button" id="optFilters" role="menuitem">⚙️ Ouvrir les filtres</button>
            <button type="button" id="optMap" role="menuitem">🗺️ Afficher/Masquer la carte</button>
          </div>
        </div>

        <!-- Ancienne rangée de boutons — gardée mais masquée par CSS -->
        <div class="hero-controls">
          <button type="button" id="saveTrip" class="minibtn">Enregistrer</button>
          <button type="button" id="clearChat" class="minibtn">Effacer</button>
          <button type="button" id="openFilters" class="minibtn" aria-haspopup="dialog" aria-controls="filtersDrawer">Ouvrir les filtres</button>
          <button type="button" id="toggleMap" class="minibtn">Afficher la carte</button>
        </div>
      </form>

      <!-- Chat panel monté ici après 1er message (masqué au chargement) -->
      <div id="heroChatMount"></div>
    </div>
  </section>

  <!-- Fallback placement (avant déplacement) + carte optionnelle -->
  <main class="shell">
    <div class="grid">
      <div class="panel chat-panel" id="chatPanel" style="display:none;">
        <div class="bar">
          <h2>Assistant Travely</h2>
        </div>
        <div id="chatLog" class="chat-log" aria-live="polite"></div>
      </div>

      <div id="mapPanel" class="panel" style="padding:12px;">
        <div id="map"></div>
        <p style="margin-top:10px;color:#666;">La carte se met à jour au fil du chat.</p>
      </div>
    </div>
  </main>

  <!-- Drawer Filtres -->
  <aside id="filtersDrawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Filtres de voyage">
    <h3>Filtres</h3>
    <p style="color:#666;font-size:.92rem;margin:0 0 10px;">Le chat te demandera ces infos et les remplira automatiquement. Tu peux aussi ajuster manuellement.</p>
    <form id="filtersForm">
      <label>Destination principale</label>
      <input id="f_destination" type="text" placeholder="Ex: Paris">

      <div class="row">
        <div>
          <label>Départ (jj/mm/aaaa)</label>
          <input id="f_from" type="text" placeholder="12/09/2025">
        </div>
        <div>
          <label>Retour (jj/mm/aaaa)</label>
          <input id="f_to" type="text" placeholder="18/09/2025">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Durée (jours)</label>
          <input id="f_duration" type="number" min="1" placeholder="7">
        </div>
        <div>
          <label>Voyageurs</label>
          <input id="f_people" type="number" min="1" placeholder="2">
        </div>
      </div>

      <label>Budget total (€)</label>
      <input id="f_budget" type="number" min="0" step="50" placeholder="1500">

      <label>Type d’hébergement</label>
      <select id="f_stay">
        <option value="">—</option>
        <option>Hôtel</option>
        <option>Appartement</option>
        <option>Auberge</option>
        <option>Mix</option>
      </select>

      <label>Thèmes</label>
      <select id="f_theme">
        <option value="">—</option>
        <option>Culture</option>
        <option>Gastronomie</option>
        <option>Nature</option>
        <option>Plage</option>
        <option>Festif</option>
      </select>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button type="button" id="saveFilters" class="actions">Enregistrer</button>
        <button type="button" id="resetFilters" class="actions">Réinitialiser</button>
        <button type="button" id="closeFilters" class="minibtn">Fermer</button>
      </div>
    </form>
  </aside>

  <footer class="footer"><p>&copy; 2025 Travely</p></footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Utilités ---
    const LS_PREFS = 'travely_prefs';
    const LS_FILTERS = 'travely_filters';
    const LS_TRIPS = 'travely_trips';
    function getJSON(k, d={}){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); }catch(e){ return d; } }
    function setJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

    // Éléments
    const log = document.getElementById('chatLog');
    const heroForm = document.getElementById('heroForm');
    const heroInput = document.getElementById('heroMsg');
    const btnFilters = document.getElementById('btnFilters');
    const drawer = document.getElementById('filtersDrawer');
    const backdrop = document.getElementById('backdrop');
    const btnToggleMapHeader = document.getElementById('btnToggleMap');
    const saveBtn = document.getElementById('saveTrip');
    const clearBtn = document.getElementById('clearChat');
    const openFiltersBtn = document.getElementById('openFilters');
    const toggleMapBtn = document.getElementById('toggleMap');
    const chatPanel = document.getElementById('chatPanel');
    const heroMount = document.getElementById('heroChatMount');
    const suggTrack = document.getElementById('suggTrack');

    // ---- Drawer (Filters) with backdrop & auto-close ----
    function showBackdrop(show){
      if(show){
        backdrop.hidden = false;
        requestAnimationFrame(()=>backdrop.classList.add('show'));
      }else{
        backdrop.classList.remove('show');
        backdrop.addEventListener('transitionend', ()=>{ backdrop.hidden = true; }, { once:true });
      }
    }
    function toggleDrawer(open){
      drawer.classList[open ? 'add' : 'remove']('open');
      drawer.setAttribute('aria-hidden', (!open).toString());
      showBackdrop(open);
      if(open){ setTimeout(()=>document.getElementById('f_destination')?.focus(), 120); }
    }
    backdrop.addEventListener('click', ()=>toggleDrawer(false));
    document.getElementById('closeFilters').addEventListener('click', ()=>toggleDrawer(false));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && drawer.classList.contains('open')) toggleDrawer(false); });
    document.getElementById('openFilters').addEventListener('click', ()=>{ fillFilters(); toggleDrawer(true); });
    btnFilters.addEventListener('click', ()=>{ fillFilters(); toggleDrawer(true); });

    function fillFilters(){
      const f = getJSON(LS_FILTERS);
      ['destination','from','to','duration','people','budget','stay','theme'].forEach(k=>{
        const el = document.getElementById('f_'+k);
        if(el) el.value = f[k] || '';
      });
    }
    function saveFilters(){
      const f = {
        destination: document.getElementById('f_destination').value.trim(),
        from: document.getElementById('f_from').value.trim(),
        to: document.getElementById('f_to').value.trim(),
        duration: document.getElementById('f_duration').value.trim(),
        people: document.getElementById('f_people').value.trim(),
        budget: document.getElementById('f_budget').value.trim(),
        stay: document.getElementById('f_stay').value,
        theme: document.getElementById('f_theme').value,
      };
      setJSON(LS_FILTERS, f);
      toggleDrawer(false);
      addBubble('Filtres enregistrés ✅', 'ai');
      renderSuggestions(defaultSuggestions());
    }
    function resetFilters(){
      setJSON(LS_FILTERS, {});
      fillFilters();
      toggleDrawer(false);
      addBubble('Filtres réinitialisés.', 'ai');
      renderSuggestions(defaultSuggestions());
    }
    document.getElementById('saveFilters').addEventListener('click', saveFilters);
    document.getElementById('resetFilters').addEventListener('click', resetFilters);

    // ---- Suggestions ----
    function defaultSuggestions(){
      return [
        "Je pars 7 jours à Paris en novembre, budget 1200€",
        "Je suis à Milan du 12/09/2025 au 18/09/2025",
        "Propose-moi un planning street-food à Tokyo",
        "Trouve-moi un hôtel central à Barcelone",
        "Optimise mon budget 1500€ pour Rome"
      ];
    }
    function renderSuggestions(items){
      // Build buttons and duplicate for seamless loop
      const btns = items.map(t => `<button class="sugg-pill" data-text="${t.replace(/"/g,'&quot;')}">${t}</button>`).join('');
      suggTrack.innerHTML = btns + btns;
      suggTrack.querySelectorAll('.sugg-pill').forEach(btn=>{
        btn.addEventListener('click', ()=>{ heroInput.value = btn.dataset.text; autoGrow(heroInput); heroInput.focus(); });
      });
      requestAnimationFrame(()=>{
        const fullW = suggTrack.scrollWidth / 2; // width of one set
        const base = 28; // seconds
        const k = Math.max(18, Math.min(70, base * (fullW/700)));
        suggTrack.style.animationDuration = k + 's';
      });
    }
    renderSuggestions(defaultSuggestions());

    function updateSuggestionsFromAI(text){
      const f = getJSON(LS_FILTERS);
      const out = [];
      const has = (w)=> new RegExp(w, 'i').test(text);
      if(has('date')||has('période')||has('\\bdu\\b')){
        out.push("Mes dates : du 12/08/2025 au 19/08/2025");
        out.push("Je ne connais pas mes dates, propose des périodes abordables");
      }
      if(has('budget')||/€|\beuros?\b/i.test(text)){
        out.push("Mon budget total est de 1500€");
        out.push("Donne-moi 2 versions : éco et confort");
      }
      if(has('hébergement')||has('hôtel')||has('appartement')){
        out.push("Trouve un hôtel central bien noté");
        out.push("Je préfère un appartement");
      }
      if(has('activité')||has('planning')||has('itinéraire')){
        out.push("Propose un itinéraire jour par jour");
        out.push("Ajoute des activités gratuites");
      }
      if(has('vol')||has('transport')){
        out.push("Propose les vols les moins chers");
        out.push("Je pars de Paris (CDG)");
      }
      if(has('quartier')){
        out.push("Quel quartier recommandes-tu ?");
      }
      if(has('enfant')||has('famille')){
        out.push("Activités adaptées aux enfants");
      }
      if(out.length===0){
        if(f.destination){
          out.push(`Propose des incontournables à ${f.destination}`);
          out.push(`Itinéraire ${f.duration||'4'} jours à ${f.destination}`);
          out.push(`Hébergement central à ${f.destination}`);
        }else{
          out.push(...defaultSuggestions());
        }
      }
      renderSuggestions(out.slice(0,10));
    }

    // ---- Input behaviors ----
    function autoGrow(t){
      t.style.height = 'auto';
      t.style.height = Math.min(t.scrollHeight, 120) + 'px';
      document.documentElement.style.setProperty('--dock-input-h', Math.max(56, t.parentElement.offsetHeight) + 'px');
    }
    heroInput.addEventListener('input', ()=>autoGrow(heroInput));
    heroInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        heroForm.requestSubmit();
      }
    });
    autoGrow(heroInput);

    // ---- Move chat under input & enable dock after first send ----
    let moved = false, docked = false;
    function ensureHeroChat(){
      if(!moved){
        heroMount.appendChild(chatPanel);
        chatPanel.style.display='block';
        document.body.classList.add('show-hero-chat');
        moved = true;
      }
      if(!docked){
        document.body.classList.add('chat-live');
        docked = true;
      }
    }

    // ---- Chat bubbles ----
    function addBubble(text, who='ai'){
      const line = document.createElement('div');
      line.className = `line ${who}`;
      const b = document.createElement('div');
      b.className = `bubble ${who}`;
      b.textContent = text;
      line.appendChild(b);
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
      if(who==='ai'){ updateSuggestionsFromAI(text); }
    }

    // ---- Map (optional) ----
    let mapInited=false, map, markersLayer, line;
    function ensureMap(){
      if(mapInited) return;
      mapInited = true;
      map = L.map('map');
      const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
      tiles.addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      map.setView([48.8566, 2.3522], 5);
      refreshMap();
      setTimeout(()=>{ map.invalidateSize(); }, 200);
    }
    function toggleMap(){
      const showing = document.body.classList.toggle('show-map');
      const btnHeader = document.getElementById('btnToggleMap');
      const btnHero = document.getElementById('toggleMap');
      if(btnHeader) btnHeader.textContent = showing ? 'Masquer la carte' : 'Afficher la carte';
      if(btnHero) btnHero.textContent = showing ? 'Masquer la carte' : 'Afficher la carte';
      if(showing){ ensureMap(); }
      if(map){ setTimeout(()=>map.invalidateSize(), 220); }
    }
    const btnHeaderMap = document.getElementById('btnToggleMap');
    if(btnHeaderMap) btnHeaderMap.addEventListener('click', toggleMap);
    toggleMapBtn && toggleMapBtn.addEventListener('click', toggleMap);

    async function refreshMap(){
      if(!markersLayer) return;
      try{
        const r = await fetch('/api/positions');
        const geo = await r.json();
        markersLayer.clearLayers();
        const coords = [];
        (geo.features || []).forEach(f=>{
          const [lng, lat] = f.geometry.coordinates;
          coords.push([lat, lng]);
          L.marker([lat,lng]).addTo(markersLayer).bindPopup(f.properties?.label || '');
        });
        if(line){ line.remove(); }
        if(coords.length>1){ line = L.polyline(coords, {weight:4}).addTo(markersLayer); }
        if(coords.length){ map.fitBounds(L.latLngBounds(coords), {padding:[20,20]}); }
      }catch(e){ console.warn('map refresh failed', e); }
    }

    // ---- Send flow ----
    async function sendMessage(text){
      if(!text) return;
      toggleDrawer(false); // close filters if open
      ensureHeroChat();
      addBubble(text, 'me');
      autoFillFiltersFromText(text);
      const payload = { message: text, prefs: getJSON(LS_PREFS), filters: getJSON(LS_FILTERS) };
      try{
        const r = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await r.json();
        addBubble(data.reply || "Je n'ai pas compris, reformule stp.", 'ai');
        if(data.filters && typeof data.filters === 'object'){
          const cur = getJSON(LS_FILTERS);
          setJSON(LS_FILTERS, Object.assign(cur, data.filters));
        }
      }catch(err){
        addBubble("Une petite erreur réseau, réessaie dans un instant.", 'ai');
        console.error(err);
      }
      log.scrollTop = log.scrollHeight;
    }

    // Heuristique d'auto-remplissage de filtres depuis le texte
    function autoFillFiltersFromText(t){
      const f = getJSON(LS_FILTERS);
      const mDest = t.match(/\b(?:à|a)\s+([A-ZÀÂÄÇÉÈÊËÎÏÔÖÙÛÜŸ][\wÀ-ÿ\-\s']+)/);
      if(mDest){ f.destination = (mDest[1]||'').trim(); }
      const mDates = t.match(/\bdu\s+(\d{1,2}\/\d{1,2}\/\d{4})\s+au\s+(\d{1,2}\/\d{1,2}\/\d{4})/i);
      if(mDates){ f.from = mDates[1]; f.to = mDates[2]; }
      const mDur = t.match(/(\d+)\s*jours?/i);
      if(mDur){ f.duration = mDur[1]; }
      const mBud = t.match(/budget[^0-9]*([0-9]{2,6})/i) || t.match(/\b([0-9]{2,6})\s*€\b/);
      if(mBud){ f.budget = mBud[1]; }
      setJSON(LS_FILTERS, f);
    }

    heroForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = heroInput.value.trim();
      if(!text) return;
      heroInput.value=''; autoGrow(heroInput);
      sendMessage(text);
    });

    clearBtn && clearBtn.addEventListener('click', ()=>{
      log.innerHTML='';
      heroInput.focus();
      renderSuggestions(defaultSuggestions());
    });

    saveBtn && saveBtn.addEventListener('click', ()=>{
      const bubbles = Array.from(document.querySelectorAll('.bubble.me')).map(b=>b.textContent);
      if(!bubbles.length){ addBubble("Envoie d'abord une demande pour que je l'enregistre.", 'ai'); return; }
      const last = bubbles[bubbles.length-1];
      const list = getJSON(LS_TRIPS, []);
      list.push({ title:last, createdAt:new Date().toISOString(), filters:getJSON(LS_FILTERS) });
      setJSON(LS_TRIPS, list);
      addBubble('Itinéraire enregistré dans Mes voyages 💾', 'ai');
    });

    // === '+' floating menu actions ===
    const plusBtn = document.getElementById('plusBtn');
    const optionsMenu = document.getElementById('optionsMenu');
    const optSave = document.getElementById('optSave');
    const optClear = document.getElementById('optClear');
    const optFilters = document.getElementById('optFilters');
    const optMap = document.getElementById('optMap');

    function closeMenu(){
      optionsMenu.classList.remove('open');
      plusBtn.setAttribute('aria-expanded','false');
      optionsMenu.setAttribute('aria-hidden','true');
    }
    function openMenu(){
      optionsMenu.classList.add('open');
      plusBtn.setAttribute('aria-expanded','true');
      optionsMenu.setAttribute('aria-hidden','false');
    }
    plusBtn.addEventListener('click',(e)=>{
      e.stopPropagation();
      optionsMenu.classList.contains('open') ? closeMenu() : openMenu();
    });
    document.addEventListener('click',(e)=>{
      if(!optionsMenu.contains(e.target) && e.target !== plusBtn){ closeMenu(); }
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu(); });

    optClear.addEventListener('click', ()=>{
      clearBtn?.click();
      closeMenu();
    });
    optSave.addEventListener('click', ()=>{
      saveBtn?.click();
      closeMenu();
    });
    optFilters.addEventListener('click', ()=>{
      fillFilters(); toggleDrawer(true); closeMenu();
    });
    optMap.addEventListener('click', ()=>{
      toggleMap(); closeMenu();
    });
  </script>
</body>
</html>
